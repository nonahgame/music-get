# agent.py
import os, random, string, shutil
from datetime import datetime
from dotenv import load_dotenv

load_dotenv()

# Folders
OUTPUT_DIR = "output"
PUBLIC_DIR = "public_downloads"
os.makedirs(OUTPUT_DIR, exist_ok=True)
os.makedirs(PUBLIC_DIR, exist_ok=True)

# Import local generators
from musicgen_generator import MusicGenGenerator
from bark_generator import BarkGenerator
from mixer import mix_vocals_and_beat

# Tools
from tools import (
    search_online_asset,
    generate_visual_mp4,
    store_generation
)

# Optional RVC
try:
    from rvc_converter import convert_with_rvc
    RVC_AVAILABLE = True
except:
    RVC_AVAILABLE = False

# GitHub uploader fallback
try:
    from agent_upload import upload_to_github
except:
    import base64, requests
    GITHUB_USER = os.getenv("GITHUB_USER")
    GITHUB_REPO = os.getenv("GITHUB_REPO")
    GITHUB_TOKEN = os.getenv("GITHUB_TOKEN")

    def upload_to_github(local_path, github_folder="d-output"):
        try:
            filename = os.path.basename(local_path)
            with open(local_path, "rb") as f:
                content = base64.b64encode(f.read()).decode("utf-8")

            url = f"https://api.github.com/repos/{GITHUB_USER}/{GITHUB_REPO}/contents/{github_folder}/{filename}"
            headers = {"Authorization": f"token {GITHUB_TOKEN}"}
            data = {"message": f"Add {filename}", "content": content}

            r = requests.put(url, json=data, headers=headers)
            return r.status_code in (200, 201)
        except Exception as e:
            print("GH upload error:", e)
            return False


# Helper: Large lyric support (6k words)
def split_lyrics(text, max_length=4000):
    chunks = []
    words = text.split()
    buff, length = [], 0
    for w in words:
        w_len = len(w) + 1
        if length + w_len > max_length:
            chunks.append(" ".join(buff))
            buff, length = [w], w_len
        else:
            buff.append(w)
            length += w_len
    if buff:
        chunks.append(" ".join(buff))
    return chunks


def run_agent(data):
    title = data.get("title", "My Hit Song")
    lyrics = data.get("lyrics", "")
    genre = data.get("genre", "hip-hop")
    voice_type = data.get("voice_type", "male")
    file_format = data.get("file_format", "mp3")

    # Generate unique ID
    ts = datetime.now().strftime("%Y%m%d_%H%M%S")
    uid = "".join(random.choices(string.ascii_lowercase + string.digits, k=6))
    base = f"{title.replace(' ', '_')[:25]}_{uid}"

    # Step A: Search background assets
    pic_url = search_online_asset("image", title)
    vid_url = search_online_asset("video", title)

    # Step B: Generate instrumental
    instrumental = os.path.join(OUTPUT_DIR, f"{base}_instrumental.wav")
    mg = MusicGenGenerator()
    mg.generate(prompt=f"{genre} instrumental", duration=45, out_path=instrumental)

    # Step C: Generate vocals
    vocal_raw = os.path.join(OUTPUT_DIR, f"{base}_vocals_raw.wav")
    bg = BarkGenerator()
    bg.generate_vocals(lyrics=lyrics, voice=voice_type, out_wav=vocal_raw)

    # Optional RVC
    final_vocals = vocal_raw
    if voice_type == "custom" and RVC_AVAILABLE:
        rvc_out = os.path.join(OUTPUT_DIR, f"{base}_rvc.wav")
        model_path = os.getenv("RVC_MODEL_PATH")
        convert_with_rvc(vocal_raw, rvc_out, model_path)
        final_vocals = rvc_out

    # Step D: Mix vocals + beat => HIGH QUALITY MP3
    final_mp3 = os.path.join(OUTPUT_DIR, f"{base}.mp3")
    mix_vocals_and_beat(
        instrumental,
        final_vocals,
        final_mp3,
        vocals_gain_dB=8.0          # BOOST VOCALS TO SOUND CLEAR
    )

    # Step E: Generate videos using TOOLS
    simple_mp4 = generate_visual_mp4(
        audio_path=final_mp3,
        file_format="simple_mp4",
        pic=pic_url,
        video=None,
        title=title,
        lyrics=lyrics.split("\n"),
        user_id=uid
    )

    high_mp4 = generate_visual_mp4(
        audio_path=final_mp3,
        file_format="high_mp4",
        pic=None,
        video=vid_url,
        title=title,
        lyrics=lyrics.split("\n"),
        user_id=uid
    )

    # Step F: Copy to public_downloads
    for f in [final_mp3, simple_mp4, high_mp4]:
        try:
            shutil.copy(f, os.path.join(PUBLIC_DIR, os.path.basename(f)))
        except:
            pass

    # Step G: Upload to GitHub
    upload_to_github(final_mp3)
    upload_to_github(simple_mp4)
    upload_to_github(high_mp4)

    # Step H: Log metadata
    store_generation(
        user_id=uid,
        title=title,
        lyrics=lyrics,
        file_path=final_mp3,
        file_format=file_format,
        pic_url=pic_url,
        video_url=vid_url
    )

    print("[AGENT] DONE:", final_mp3, simple_mp4, high_mp4)

